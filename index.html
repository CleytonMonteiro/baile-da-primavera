<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AABB ARACAJU</title>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS COMPLETO EMBUTIDO */
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; display: flex; flex-direction: column; align-items: center; text-align: center; }
        h1 { color: #007bff; margin-bottom: 10px; }
        .event-date { font-size: 1.5em; font-weight: bold; color: #555; margin-top: -10px; margin-bottom: 20px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; font-size: 1.2em; color: #333; }
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-link { position: absolute; top: 20px; right: 20px; text-decoration: none; font-weight: bold; color: #007bff; padding: 10px 15px; border: 1px solid #007bff; border-radius: 5px; transition: background-color 0.2s, color 0.2s; z-index: 100; }
        .admin-link:hover { background-color: #007bff; color: white; }
        #auth-status { margin-bottom: 20px; }
        .search-filter-container, .export-container { width: 100%; max-width: 800px; padding: 20px; margin-bottom: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; align-items: center; box-sizing: border-box; }
        .export-container { flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 15px; }
        .export-container label { font-weight: bold; }
        #search-input, .export-container select { width: 100%; max-width: 400px; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .export-container select { max-width: 250px; padding: 8px; font-size: 0.9em; }
        .filter-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .filter-btn, .export-container button { padding: 8px 16px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 20px; background-color: #f8f9fa; color: #333; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: bold; }
        .filter-btn:hover, .export-container button:hover { background-color: #e2e6ea; }
        .filter-btn.active { background-color: #007bff; color: white; border-color: #007bff; }
        .stats-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; width: 100%; max-width: 800px; box-sizing: border-box; }
        .stat-item { font-size: 1.1em; color: #333; padding: 8px 15px; border-radius: 20px; background-color: #e9ecef; }
        .stat-item strong { font-size: 1.2em; }
        .stat-item.livre { background-color: #28a745; color: white; }
        .stat-item.reservada { background-color: #ffc107; color: #333; }
        .stat-item.vendida { background-color: #dc3545; color: white; }
        .stat-item.arrecadado { background-color: #17a2b8; color: white; }
        #stat-arrecadado { display: none; }
        .layout-salão { width: 100%; max-width: 1400px; overflow-x: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); white-space: nowrap; }
        .scroll-container { display: flex; gap: 30px; padding: 10px; }
        .secao-mesas { display: flex; gap: 20px; }
        .coluna-mesas { display: flex; flex-direction: column; gap: 15px; }
        .mesa { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; font-weight: bold; font-size: 1.2em; color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .mesa:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .mesa.livre { background-color: #28a745; }
        .mesa.reservada { background-color: #ffc107; }
        .mesa.vendida { background-color: #dc3545; }
        .legenda { display: flex; justify-content: center; gap: 20px; margin-top: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .legenda-item { display: flex; align-items: center; gap: 8px; }
        .legenda-cor { width: 20px; height: 20px; border-radius: 4px; }
        .modal { display: none; flex-direction: column; align-items: center; gap: 15px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; width: 90%; max-width: 350px; }
        .modal label { align-self: flex-start; font-weight: bold; }
        .modal input, .modal select, .modal button { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; }
        .checkbox-container { display: flex; align-items: center; gap: 10px; width: 100%; margin-top: 5px; }
        .checkbox-container input[type="checkbox"] { width: auto; }
        .checkbox-container label { font-weight: normal; }
        .modal button { cursor: pointer; background-color: #007bff; color: white; border: none; font-weight: bold; transition: background-color 0.2s; }
        .modal button:hover { background-color: #0056b3; }
        .modal .botoes-form { display: flex; justify-content: space-between; gap: 10px; width: 100%; margin-top: 10px; }
        .modal .botoes-form button { flex-grow: 1; }
        .liberar-btn { background-color: #dc3545 !important; }
        .liberar-btn:hover { background-color: #c82333 !important; }
        .voltar-btn { background-color: #6c757d !important; }
        .voltar-btn:hover { background-color: #545b62 !important; }
        .mensagem-erro { color: #dc3545; font-size: 0.9em; display: none; align-self: flex-start; text-align: left; width: 100%; }
        
        /* Estilos para o Painel de Informações Lateral */
        .info-panel {
            position: fixed;
            top: 0;
            right: -100%; /* Começa fora da tela */
            width: 320px;
            height: 100%;
            background-color: #fff;
            box-shadow: -5px 0 15px rgba(0,0,0,0.15);
            padding: 25px;
            box-sizing: border-box;
            transition: right 0.4s ease-in-out;
            z-index: 9998;
            text-align: left;
            display: flex;
            flex-direction: column;
        }
        .info-panel.visible {
            right: 0; /* Desliza para a tela */
        }
        .info-panel h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 10px;
        }
        .info-panel p {
            margin: 12px 0;
            line-height: 1.6;
            font-size: 1.1em;
            color: #555;
        }
        .info-panel p strong {
            display: inline-block;
            width: 90px;
            color: #333;
        }
        .info-panel .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            color: #aaa;
            line-height: 1;
        }
        .info-panel .close-btn:hover {
            color: #333;
        }
        #info-panel-dados-restritos {
            border-top: 2px solid #f0f2f5;
            margin-top: 15px;
            padding-top: 10px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <span>Carregando Mesas...</span>
    </div>

    <h1 id="event-title">Carregando Evento...</h1>
    <p id="event-date" class="event-date"></p>
    
    <a href="admin.html" class="admin-link">Painel de Admin</a>

    <div id="auth-status">
        <span id="status-text">Faça login para gerenciar as mesas.</span>
        <button id="logout-btn" style="display: none;">Sair</button>
    </div>

    <div class="search-filter-container">
        <input type="search" id="search-input" placeholder="Buscar por Nº da Mesa ou Nome...">
        <div id="filter-buttons" class="filter-buttons">
            <button class="filter-btn active" data-status="all">Todas</button>
            <button class="filter-btn" data-status="livre">Livres</button>
            <button class="filter-btn" data-status="reservada">Reservadas</button>
            <button class="filter-btn" data-status="vendida">Vendidas</button>
        </div>
    </div>

    <div id="stats-container" class="stats-container">
        <span class="stat-item">Total: <strong id="total-count">0</strong></span>
        <span class="stat-item livre">Livres: <strong id="livre-count">0</strong></span>
        <span class="stat-item reservada">Reservadas: <strong id="reservada-count">0</strong></span>
        <span class="stat-item vendida">Vendidas: <strong id="vendida-count">0</strong></span>
        <span id="stat-arrecadado" class="stat-item arrecadado">Arrecadado: <strong id="arrecadado-total">R$ 0,00</strong></span>
    </div>
    
    <div id="export-container" class="export-container" style="display: none;">
        <label for="export-filter">Exportar Relatório:</label>
        <select id="export-filter">
            <option value="ocupadas">Vendidas e Reservadas</option>
            <option value="vendida">Apenas Vendidas</option>
            <option value="reservada">Apenas Reservadas</option>
            <option value="livre">Apenas Livres</option>
        </select>
        <button id="export-csv-btn">Gerar CSV</button>
        <button id="export-pdf-btn">Gerar PDF</button>
    </div>

    <div class="legenda">
        <div class="legenda-item">
            <div class="legenda-cor" style="background-color: #28a745;"></div>
            <span>Livre</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor" style="background-color: #ffc107;"></div>
            <span>Reservada</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor" style="background-color: #dc3545;"></div>
            <span>Vendida</span>
        </div>
    </div>

    <div class="layout-salão">
        <div class="scroll-container">
            <div class="secao-mesas" id="col-esq"></div>
            <div class="secao-mesas" id="col-cen"></div>
            <div class="secao-mesas" id="col-dir"></div>
        </div>
    </div>

    <div id="info-panel" class="info-panel">
        <button id="info-panel-close-btn" class="close-btn">&times;</button>
        <h3>Detalhes da Mesa <span id="info-panel-numero"></span></h3>
        <p><strong>Status:</strong> <span id="info-panel-status"></span></p>
        <p><strong>Nome:</strong> <span id="info-panel-nome"></span></p>
        <div id="info-panel-dados-restritos">
            <p><strong>Preço:</strong> <span id="info-panel-preco"></span></p>
            <p><strong>Contato:</strong> <span id="info-panel-contato"></span></p>
            <p><strong>Email:</strong> <span id="info-panel-email"></span></p>
            <p><strong>Pagamento:</strong> <span id="info-panel-pagamento"></span></p>
        </div>
    </div>

    <div id="login-form" class="modal">
        <h2>Login do Supervisor</h2>
        <label for="login-email">E-mail:</label>
        <input type="email" id="login-email" placeholder="E-mail de supervisor" required>
        <label for="login-senha">Senha:</label>
        <input type="password" id="login-senha" placeholder="Senha" required>
        <span id="login-erro" class="mensagem-erro">E-mail ou senha incorretos.</span>
        <div class="botoes-form">
            <button id="login-btn">Entrar</button>
            <button id="cancelar-login-btn" class="voltar-btn">Cancelar</button>
        </div>
    </div>

    <div id="cadastro-form" class="modal">
        <h2 id="modal-titulo">Gerenciar Mesa <span id="modal-numero-mesa"></span></h2>
        <input type="hidden" id="mesa-numero">
        <label for="nome-completo">Nome Completo:</label>
        <input type="text" id="nome-completo" placeholder="Digite o nome completo" required>
        <span id="nome-erro" class="mensagem-erro">O nome é obrigatório para reservar/vender.</span>
        <label for="preco-mesa">Preço (R$):</label>
        <input type="number" id="preco-mesa" placeholder="Ex: 150.00" step="0.01" min="0">
        <label for="contato-mesa">Nº de Contato:</label>
        <input type="tel" id="contato-mesa" placeholder="(99) 99999-9999">
        <label for="email-mesa">E-mail:</label>
        <input type="email" id="email-mesa" placeholder="exemplo@email.com">
        <label for="status-mesa">Status:</label>
        <select id="status-mesa">
            <option value="livre">Livre</option>
            <option value="reservada">Reservada</option>
            <option value="vendida">Vendida</option>
        </select>
        <div id="pagamento-container" class="checkbox-container">
            <input type="checkbox" id="pagamento-confirmado">
            <label for="pagamento-confirmado">Pagamento Confirmado?</label>
        </div>
        <div class="botoes-form">
            <button id="liberar-btn" class="liberar-btn">Liberar Mesa</button>
            <button id="salvar-btn">Salvar</button>
            <button id="cancelar-btn" class="voltar-btn">Cancelar</button>
        </div>
    </div>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGVgqwdSOJJn0plwfKkHEsofxvfHFCf6w",
            authDomain: "layoutsalaodefesta.firebaseapp.com",
            databaseURL: "https://layoutsalaodefesta-default-rtdb.firebaseio.com",
            projectId: "layoutsalaodefesta",
            storageBucket: "layoutsalaodefesta.firebasestorage.app",
            messagingSenderId: "1060371531536",
            appId: "1:1060371531536:web:fbed496ff9a78982580795",
            measurementId: "G-L21G98V5CL"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const layoutRef = ref(database, 'layoutMesas');
        const mesasRef = ref(database, 'mesas');
        const eventoRef = ref(database, 'informacoesEvento');

        let mesasDataGlobal = {};
        let layoutMesasGlobal = {};
        let isSupervisorLoggedIn = false;
        let searchTerm = '';
        let filterStatus = 'all';
        
        document.addEventListener('DOMContentLoaded', () => {
            const layoutContainer = document.querySelector('.scroll-container');
            const statusText = document.getElementById('status-text');
            const logoutBtn = document.getElementById('logout-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const eventTitle = document.getElementById('event-title');
            const eventDate = document.getElementById('event-date');
            const searchInput = document.getElementById('search-input');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const totalCountSpan = document.getElementById('total-count');
            const livreCountSpan = document.getElementById('livre-count');
            const reservadaCountSpan = document.getElementById('reservada-count');
            const vendidaCountSpan = document.getElementById('vendida-count');
            const arrecadadoTotalSpan = document.getElementById('arrecadado-total');
            const statArrecadado = document.getElementById('stat-arrecadado');
            const loginForm = document.getElementById('login-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginSenhaInput = document.getElementById('login-senha');
            const loginBtn = document.getElementById('login-btn');
            const loginErroSpan = document.getElementById('login-erro');
            const cancelarLoginBtn = document.getElementById('cancelar-login-btn');
            const cadastroForm = document.getElementById('cadastro-form');
            const modalNumeroMesa = document.getElementById('modal-numero-mesa');
            const mesaNumeroInput = document.getElementById('mesa-numero');
            const nomeCompletoInput = document.getElementById('nome-completo');
            const statusMesaSelect = document.getElementById('status-mesa');
            const salvarBtn = document.getElementById('salvar-btn');
            const cancelarBtn = document.getElementById('cancelar-btn');
            const liberarBtn = document.getElementById('liberar-btn');
            const nomeErroSpan = document.getElementById('nome-erro');
            const precoMesaInput = document.getElementById('preco-mesa');
            const contatoMesaInput = document.getElementById('contato-mesa');
            const emailMesaInput = document.getElementById('email-mesa');
            const pagamentoContainer = document.getElementById('pagamento-container');
            const pagamentoCheckbox = document.getElementById('pagamento-confirmado');
            const exportContainer = document.getElementById('export-container');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportFilter = document.getElementById('export-filter');
            
            // Elementos do Painel de Informações
            const infoPanel = document.getElementById('info-panel');
            const infoPanelCloseBtn = document.getElementById('info-panel-close-btn');
            const infoPanelNumero = document.getElementById('info-panel-numero');
            const infoPanelStatus = document.getElementById('info-panel-status');
            const infoPanelNome = document.getElementById('info-panel-nome');
            const infoPanelDadosRestritos = document.getElementById('info-panel-dados-restritos');
            const infoPanelPreco = document.getElementById('info-panel-preco');
            const infoPanelContato = document.getElementById('info-panel-contato');
            const infoPanelEmail = document.getElementById('info-panel-email');
            const infoPanelPagamento = document.getElementById('info-panel-pagamento');


            function showToast(text, isError = false) { Toastify({ text: text, duration: 3000, gravity: "top", position: "right", backgroundColor: isError ? "linear-gradient(to right, #ff5f6d, #ffc371)" : "linear-gradient(to right, #00b09b, #96c93d)", }).showToast(); }
            function updateStats() {
                let countTotal = 0, countReservada = 0, countVendida = 0, totalArrecadado = 0;
                if (layoutMesasGlobal) { for (const colId in layoutMesasGlobal) { countTotal += (layoutMesasGlobal[colId] || []).length; } }
                if (mesasDataGlobal) {
                    Object.values(mesasDataGlobal).forEach(mesa => {
                        if (mesa.status === 'reservada') { countReservada++; }
                        else if (mesa.status === 'vendida') { countVendida++; if (mesa.pago === true) { totalArrecadado += parseFloat(mesa.preco) || 0; } }
                    });
                }
                const countLivre = countTotal - (countReservada + countVendida);
                totalCountSpan.textContent = countTotal;
                livreCountSpan.textContent = countLivre;
                reservadaCountSpan.textContent = countReservada;
                vendidaCountSpan.textContent = countVendida;
                arrecadadoTotalSpan.textContent = `R$ ${totalArrecadado.toFixed(2).replace('.', ',')}`;
            }
            function renderizarLayoutPublico() {
                const secoes = { esq: document.getElementById('col-esq'), cen: document.getElementById('col-cen'), dir: document.getElementById('col-dir') };
                Object.values(secoes).forEach(sec => { if(sec) sec.innerHTML = ''; });
                if (!layoutMesasGlobal) { if(loadingOverlay) loadingOverlay.style.display = 'none'; return; }
                updateStats();
                for (const colId in layoutMesasGlobal) {
                    let secaoAlvo = null;
                    if (colId.startsWith('col-esq')) secaoAlvo = secoes.esq;
                    else if (colId.startsWith('col-cen')) secaoAlvo = secoes.cen;
                    else if (colId.startsWith('col-dir')) secaoAlvo = secoes.dir;
                    if (secaoAlvo) {
                        const colunaDiv = document.createElement('div');
                        colunaDiv.classList.add('coluna-mesas');
                        const mesasArray = Array.isArray(layoutMesasGlobal[colId]) ? layoutMesasGlobal[colId] : [];
                        mesasArray.forEach(mesaNum => {
                            const mesaData = mesasDataGlobal[mesaNum] || { status: 'livre' };
                            const searchText = searchTerm.toLowerCase();
                            const statusMatch = filterStatus === 'all' || mesaData.status === filterStatus;
                            const searchMatch = !searchText || mesaNum.toString().includes(searchText) || (mesaData.nome && mesaData.nome.toLowerCase().includes(searchText));
                            if (statusMatch && searchMatch) {
                                const mesaDiv = document.createElement('div');
                                mesaDiv.classList.add('mesa', mesaData.status);
                                mesaDiv.textContent = mesaNum.toString().padStart(2, '0');
                                mesaDiv.dataset.numero = mesaNum;
                                colunaDiv.appendChild(mesaDiv);
                            }
                        });
                        secaoAlvo.appendChild(colunaDiv);
                    }
                }
                if(loadingOverlay) loadingOverlay.style.display = 'none';
            }
            function abrirModalCadastro(mesaNum) {
                const mesaData = mesasDataGlobal[mesaNum] || { status: 'livre' };
                modalNumeroMesa.textContent = mesaNum.toString().padStart(2, '0');
                mesaNumeroInput.value = mesaNum;
                nomeCompletoInput.value = mesaData.nome || '';
                statusMesaSelect.value = mesaData.status || 'livre';
                precoMesaInput.value = mesaData.preco || '';
                contatoMesaInput.value = mesaData.contato || '';
                emailMesaInput.value = mesaData.email || '';
                pagamentoCheckbox.checked = mesaData.pago || false;
                pagamentoContainer.style.display = (statusMesaSelect.value === 'vendida') ? 'flex' : 'none';
                cadastroForm.style.display = 'flex';
            }
            function getExportData(filterValue) {
                const allTablesData = [];
                if (layoutMesasGlobal) { for (const colId in layoutMesasGlobal) { (layoutMesasGlobal[colId] || []).forEach(numeroMesa => { const data = mesasDataGlobal[numeroMesa] || { status: 'livre' }; allTablesData.push({ numero: parseInt(numeroMesa), nome: data.nome || '', contato: data.contato || '', email: data.email || '', status: data.status || 'livre' }); }); } }
                const filteredData = allTablesData.filter(table => { if (filterValue === 'ocupadas') { return table.status === 'reservada' || table.status === 'vendida'; } return table.status === filterValue; });
                return filteredData.sort((a, b) => a.numero - b.numero);
            }

            // Função para mostrar o painel lateral com informações
            function showInfoPanel(mesaNum) {
                const mesaData = mesasDataGlobal[mesaNum] || { status: 'livre' };
                
                infoPanelNumero.textContent = mesaNum.toString().padStart(2, '0');
                infoPanelStatus.textContent = mesaData.status.charAt(0).toUpperCase() + mesaData.status.slice(1);
                infoPanelNome.textContent = (mesaData.nome && mesaData.nome.toUpperCase()) || '---';

                // Lógica para mostrar/ocultar dados com base no login
                if (isSupervisorLoggedIn) {
                    infoPanelPreco.textContent = `R$ ${(parseFloat(mesaData.preco) || 0).toFixed(2)}`;
                    infoPanelContato.textContent = mesaData.contato || '---';
                    infoPanelEmail.textContent = mesaData.email || '---';
                    if (mesaData.status === 'vendida') {
                        infoPanelPagamento.textContent = mesaData.pago ? 'Confirmado' : 'Pendente';
                    } else {
                        infoPanelPagamento.textContent = 'N/A';
                    }
                    infoPanelDadosRestritos.style.display = 'block';
                } else {
                    infoPanelDadosRestritos.style.display = 'none';
                }

                infoPanel.classList.add('visible');
            }

            const phoneMask = IMask(contatoMesaInput, { mask: '(00) 00000-0000' });
            nomeCompletoInput.addEventListener('input', () => { nomeCompletoInput.value = nomeCompletoInput.value.toUpperCase(); });
            statusMesaSelect.addEventListener('change', () => {
                pagamentoContainer.style.display = (statusMesaSelect.value === 'vendida') ? 'flex' : 'none';
                if (statusMesaSelect.value !== 'vendida') { pagamentoCheckbox.checked = false; }
            });
            searchInput.addEventListener('input', (e) => { searchTerm = e.target.value; renderizarLayoutPublico(); });
            filterButtonsContainer.addEventListener('click', (e) => { const target = e.target.closest('.filter-btn'); if (target) { filterButtonsContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); target.classList.add('active'); filterStatus = target.dataset.status; renderizarLayoutPublico(); } });
            
            // Lógica de Clique Inteligente (CORRIGIDA)
            layoutContainer.addEventListener('click', (e) => {
                const mesaClicada = e.target.closest('.mesa');
                if (!mesaClicada) return;

                const mesaNum = mesaClicada.dataset.numero;
                const mesaData = mesasDataGlobal[mesaNum] || { status: 'livre' };

                if (mesaData.status === 'vendida' || mesaData.status === 'reservada') {
                    // Se a mesa está ocupada, mostra o painel de informações
                    showInfoPanel(mesaNum);
                } else if (mesaData.status === 'livre') {
                    // Se a mesa está livre, verifica o login
                    if (isSupervisorLoggedIn) {
                        // Se logado, abre o modal de gestão
                        abrirModalCadastro(mesaNum);
                    } else {
                        // Se NÃO estiver logado, abre o modal de LOGIN
                        loginForm.style.display = 'flex';
                    }
                }
            });
            
            // Evento para fechar o painel de informações
            infoPanelCloseBtn.addEventListener('click', () => {
                infoPanel.classList.remove('visible');
            });


            loginBtn.addEventListener('click', () => { signInWithEmailAndPassword(auth, loginEmailInput.value, loginSenhaInput.value).then(() => { loginForm.style.display = 'none'; loginErroSpan.style.display = 'none'; loginEmailInput.value = ''; loginSenhaInput.value = ''; }).catch(() => loginErroSpan.style.display = 'block'); });
            salvarBtn.addEventListener('click', () => {
                const mesaNum = mesaNumeroInput.value;
                const nome = nomeCompletoInput.value.trim();
                const status = statusMesaSelect.value;
                const preco = parseFloat(precoMesaInput.value) || 0;
                const contato = contatoMesaInput.value;
                const email = emailMesaInput.value.trim();
                const pago = pagamentoCheckbox.checked;
                if (!nome && status !== 'livre') { nomeErroSpan.style.display = 'block'; return; }
                nomeErroSpan.style.display = 'none';
                const mesaDataParaSalvar = { nome, status, preco, contato, email, pago: (status === 'vendida') ? pago : false };
                update(ref(database, 'mesas/' + mesaNum), mesaDataParaSalvar).then(() => { cadastroForm.style.display = 'none'; showToast("Mesa atualizada com sucesso!"); }).catch((error) => showToast("Erro ao salvar: " + error.message, true));
            });
            liberarBtn.addEventListener('click', () => { const mesaNum = mesaNumeroInput.value; update(ref(database, 'mesas/' + mesaNum), { nome: '', status: 'livre', contato: '', email: '', pago: false }).then(() => { cadastroForm.style.display = 'none'; showToast(`Mesa ${mesaNum} liberada!`); }); });
            cancelarBtn.addEventListener('click', () => {
                cadastroForm.style.display = 'none';
                infoPanel.classList.remove('visible');
});
            cancelarLoginBtn.addEventListener('click', () => loginForm.style.display = 'none');
            logoutBtn.addEventListener('click', () => {
                signOut(auth);
                infoPanel.classList.remove('visible');
            });
            exportCsvBtn.addEventListener('click', () => {
                const filterValue = exportFilter.value; const data = getExportData(filterValue); if (data.length === 0) { showToast("Nenhuma mesa encontrada para exportar com este filtro.", true); return; }
                let csvContent = "Numero da Mesa,Nome Completo,Contato,E-mail,Status\n";
                data.forEach(item => { csvContent += `${item.numero},"${item.nome}","${item.contato}","${item.email}","${item.status}"\n`; });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a"); const url = URL.createObjectURL(blob); const fileName = `relatorio_mesas_${filterValue}.csv`;
                link.setAttribute("href", url); link.setAttribute("download", fileName); link.style.visibility = 'hidden';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });
            exportPdfBtn.addEventListener('click', () => {
                const filterValue = exportFilter.value; const data = getExportData(filterValue); if (data.length === 0) { showToast("Nenhuma mesa encontrada para exportar com este filtro.", true); return; }
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                const tableColumn = ["Nº", "Nome Completo", "Contato", "E-mail", "Status"]; const tableRows = [];
                data.forEach(item => { tableRows.push([ item.numero, item.nome, item.contato, item.email, item.status ]); });
                const filterText = exportFilter.options[exportFilter.selectedIndex].text;
                doc.text(`Relatório de Mesas: ${filterText}`, 14, 15);
                doc.autoTable(tableColumn, tableRows, { startY: 20 }); const fileName = `relatorio_mesas_${filterValue}.pdf`; doc.save(fileName);
            });
            
            onValue(eventoRef, (snapshot) => {
                const data = snapshot.val();
                const nomeEvento = (data && data.nome) ? data.nome : "Evento AABB";
                eventTitle.textContent = nomeEvento; document.title = `AABB ARACAJU - ${nomeEvento}`;
                if (data && data.data) { const [ano, mes, dia] = data.data.split('-'); eventDate.textContent = `${dia}/${mes}/${ano}`; } else { eventDate.textContent = ''; }
            });
            onAuthStateChanged(auth, (user) => {
                isSupervisorLoggedIn = !!user;
                if (user) {
                    statusText.textContent = `Logado como: ${user.email}`;
                    logoutBtn.style.display = 'inline-block';
                    exportContainer.style.display = 'flex';
                    statArrecadado.style.display = 'inline-block';
                } else {
                    statusText.textContent = 'Clique em uma mesa para gerenciar ou ver detalhes.';
                    logoutBtn.style.display = 'none';
                    exportContainer.style.display = 'none';
                    statArrecadado.style.display = 'none';
                }
            });
            onValue(layoutRef, (snapshot) => {
                layoutMesasGlobal = snapshot.val() || {};
                onValue(mesasRef, (mesasSnapshot) => {
                    mesasDataGlobal = mesasSnapshot.val() || {};
                    renderizarLayoutPublico();
                });
            });
        });
    </script>
</body>
</html>